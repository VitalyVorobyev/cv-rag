# Task Spec: TASK-012 — Add IngestService integration tests

**Author**: Architect
**Date**: 2026-02-15
**Priority**: low
**Effort**: small (1-2 files)

## Goal

Add deterministic offline tests for `cv_rag/ingest/service.py` to validate paper-selection behavior for `ingest_latest`, `ingest_ids`, and `ingest_jsonl`, including exact-version dedupe integration and stats reporting.

## Background

`IngestService` is the domain service responsible for selecting which arXiv papers should be passed into the ingest pipeline (metadata fetch + exact-version skipping + legacy migration hook). CLI handlers use this service for all ingest entrypoints.

There are CLI-level ingest tests, but no direct tests for the service’s orchestration and return objects. Adding service tests reduces regression risk when changing dedupe/migration wiring, stats computation, and JSONL ID loading behavior.

## Interface Contract

No production API changes. Tests should cover these existing call surfaces:

```python
from pathlib import Path

from cv_rag.ingest.models import PaperMetadata
from cv_rag.ingest.service import ExplicitIngestSelection, IngestService, LatestIngestSelection


class IngestService:
    def ingest_latest(self, *, limit: int, skip_ingested: bool) -> LatestIngestSelection:
        """Fetch latest cs.CV metadata and optionally skip exact versions already ingested."""

    def ingest_ids(self, *, ids: list[str], skip_ingested: bool) -> ExplicitIngestSelection:
        """Fetch metadata for explicit IDs and optionally skip exact versions already ingested."""

    def ingest_jsonl(
        self,
        *,
        source: Path,
        limit: int | None,
        skip_ingested: bool,
    ) -> ExplicitIngestSelection:
        """Load IDs from JSONL, fetch metadata, and optionally skip exact versions already ingested."""
```

## File Plan

| Action | File | Description |
|--------|------|-------------|
| create | `tests/test_ingest_service.py` | Offline unit/integration tests for `IngestService` using injected fakes |

## Error Handling

- `ingest_jsonl()` should propagate `FileNotFoundError` and `ValueError` from `load_arxiv_ids_from_jsonl` (CLI is responsible for user-facing error handling).
- No new `CvRagError` subclasses are expected for this task (service returns selections and delegates exceptions from injected dependencies).

## Testing Notes

Use constructor injection to keep tests deterministic and offline:

- Provide fake implementations for:
  - `fetch_latest_fn`, `fetch_by_ids_fn`
  - `find_and_migrate_legacy_versions_fn`, `load_ingested_versions_fn`
  - `filter_papers_by_exact_version_fn`, `build_explicit_ingest_stats_fn`
  - `load_arxiv_ids_from_jsonl_fn`, `canonical_requested_ids_fn`

Recommended test cases (minimum set):

1. `ingest_latest(skip_ingested=False)`:
   - does **not** call migration/version-loading hooks
   - calls `fetch_latest_fn(..., skip_arxiv_id_with_version=None, stats=...)`
   - returns `LatestIngestSelection(migration=None, skipped_after_fetch=0)`
2. `ingest_latest(skip_ingested=True)`:
   - calls migration + version-loading
   - passes `skip_arxiv_id_with_version=<ingested_versions>` to `fetch_latest_fn`
   - applies `filter_papers_by_exact_version_fn` and returns `skipped_after_fetch` count
3. `ingest_ids()` with no canonical IDs:
   - returns empty selection with zeroed `ExplicitIngestStats`
   - does not call `fetch_by_ids_fn`
4. `ingest_ids(skip_ingested=False)`:
   - calls `fetch_by_ids_fn(..., resolve_unversioned_to_latest=False)`
   - does not call exact-version filter hook
   - sets `stats.to_ingest == len(papers)`
5. `ingest_ids(skip_ingested=True)`:
   - calls migration + version-loading
   - calls `fetch_by_ids_fn(..., resolve_unversioned_to_latest=True)`
   - applies exact-version filter; populates `stats.skipped_existing` and `stats.to_ingest`
6. `ingest_jsonl()`:
   - honors `limit` before canonicalization
   - returns `skipped_records` from JSONL loader
   - otherwise mirrors `ingest_ids()` behavior (including skip_ingested toggles)
7. `ingest_jsonl()` error propagation:
   - fake JSONL loader raises `FileNotFoundError`/`ValueError` → service raises same exception.

## Out of Scope

- Testing the full ingest pipeline (`cv_rag/ingest/pdf_pipeline.py`) or any external services (GROBID/Ollama/Qdrant)
- CLI output formatting (already covered by CLI tests)
