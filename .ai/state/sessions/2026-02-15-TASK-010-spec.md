# Task Spec: TASK-010 — Add MLX runner tests

**Author**: Architect
**Date**: 2026-02-15
**Priority**: medium
**Effort**: small (1-2 files)

## Goal

Add unit tests for the subprocess-based MLX runner to prevent regressions in generation/streaming error handling without requiring an MLX runtime.

## Background

`cv_rag/answer/mlx_runner.py` is a thin wrapper around `subprocess.run`/`subprocess.Popen`. Today it is only exercised indirectly via CLI tests that monkeypatch generation at the CLI layer, so the runner’s command construction and failure modes are untested.

## Interface Contract

No public API changes. Tests should cover existing functions:

```python
from collections.abc import Generator

from cv_rag.shared.errors import GenerationError

def mlx_generate(
    *,
    model: str,
    prompt: str,
    max_tokens: int,
    temperature: float,
    top_p: float,
    seed: int | None = None,
) -> str:
    """Run MLX generation subprocess and return the generated text.

    Raises GenerationError on failure (not found, non-zero exit, empty output).
    """

def mlx_generate_stream(
    *,
    model: str,
    prompt: str,
    max_tokens: int,
    temperature: float,
    top_p: float,
    seed: int | None = None,
) -> Generator[str, None, None]:
    """Yield text chunks from MLX generation subprocess."""

def sse_event(event: str, data: object) -> str:
    """Format a Server-Sent Events (SSE) message."""
```

## File Plan

| Action | File | Description |
|--------|------|-------------|
| create | `tests/test_mlx_runner.py` | Unit tests for `mlx_generate`, `mlx_generate_stream`, and `sse_event` |

## Error Handling

- Assert `GenerationError` is raised for:
  - `subprocess.run` / `subprocess.Popen` raising `FileNotFoundError`
  - non-zero exit codes (with and without stderr/stdout detail)
  - empty stdout on success path (`mlx_generate`)
  - non-zero `process.returncode` after streaming completes (`mlx_generate_stream`)

## Testing Notes

Implement `tests/test_mlx_runner.py` with monkeypatched subprocess calls only (offline, deterministic).

Recommended test cases:

1. `mlx_generate` success:
   - Fake `subprocess.run` returns `returncode=0` and `stdout="  ok\\n"` → returns `"ok"`.
   - Verify command includes `sys.executable -m mlx_lm generate` and key flags (`--model`, `--prompt`, `--max-tokens`, `--temp`, `--top-p`, `--verbose False`).
2. `mlx_generate` includes seed:
   - With `seed=123`, verify `--seed 123` is present in the command passed to `subprocess.run`.
3. `mlx_generate` missing runtime:
   - Fake `subprocess.run` raises `FileNotFoundError` → raises `GenerationError` with the “runtime … not found” message.
4. `mlx_generate` non-zero return with detail:
   - Fake `returncode=1`, `stderr="bad"` → raises `GenerationError` containing `"bad"`.
5. `mlx_generate` non-zero return without detail:
   - Fake `returncode=2`, empty stdout/stderr → raises `GenerationError` mentioning exit code `2`.
6. `mlx_generate` empty output:
   - Fake `returncode=0`, `stdout="\\n\\n"` → raises `GenerationError` for empty answer.
7. `mlx_generate_stream` success yields chunks:
   - Fake `Popen` returns a process whose `stdout` iterates `["a", "b"]`, `returncode=0` after `.wait()`.
   - Assert yielded chunks preserve order and content.
8. `mlx_generate_stream` missing runtime:
   - Fake `subprocess.Popen` raises `FileNotFoundError` → raises `GenerationError`.
9. `mlx_generate_stream` non-zero exit raises after yielding:
   - Fake `stdout` yields at least one chunk, `.wait()` sets `returncode != 0`, and `stderr.read()` returns `"oops"`.
   - Assert iteration yields expected chunks, then raises `GenerationError` containing `"oops"` on the next `next()` call after the last chunk.
10. `sse_event` formatting:
   - For `data="x\\ny"`, ensure output has `event: <event>` and two `data:` lines, followed by a blank line.
   - For `data={"k": "v"}`, ensure JSON is emitted in the `data:` line(s).

## Out of Scope

- Running a real MLX model or asserting model-quality output
- Changing subprocess invocation semantics (flags, buffering), unless tests expose a clear bug
